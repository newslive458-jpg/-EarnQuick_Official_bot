require('dotenv').config();
const express = require('express');
const bodyParser = require('body-parser');
const { Pool } = require('pg');
const app = express();
const port = process.env.PORT || 3000;

app.use(bodyParser.json());
app.use(express.static('public'));

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

// ইউজার পয়েন্ট দেখানো
app.get('/user/:id', async (req, res) => {
  const id = req.params.id;
  const result = await pool.query('SELECT coins, ads_watched, referrals FROM users WHERE telegram_id=$1', [id]);
  if(result.rows.length > 0) res.json(result.rows[0]);
  else res.json({coins:0, ads_watched:0, referrals:0});
});

// এড দেখার পর রিওয়ার্ড
app.post('/watch_ad', async (req,res)=>{
  const { telegram_id } = req.body;
  const reward = 10;
  await pool.query(`
    INSERT INTO users(telegram_id, coins, ads_watched, referrals)
    VALUES($1,$2,1,0)
    ON CONFLICT(telegram_id)
    DO UPDATE SET coins=users.coins+$2, ads_watched=users.ads_watched+1
  `, [telegram_id, reward]);
  res.json({success:true, coins_added:reward});
});

// রেফারেল
app.post('/referral', async(req,res)=>{
  const { telegram_id, ref_code } = req.body;
  const reward = 250;
  const user = await pool.query('SELECT * FROM users WHERE telegram_id=$1', [telegram_id]);
  if(user.rows.length===0){
    await pool.query('INSERT INTO users(telegram_id, coins, ads_watched, referrals) VALUES($1,0,0,0)', [telegram_id]);
    await pool.query('UPDATE users SET coins=coins+$1 WHERE telegram_id=$2',[reward,ref_code]);
    res.json({success:true, reward_given:reward});
  } else res.json({success:false, msg:'Already joined'});
});

// উইথড্র
app.post('/withdraw', async(req,res)=>{
  const { telegram_id, method, account } = req.body;
  const user = await pool.query('SELECT coins FROM users WHERE telegram_id=$1', [telegram_id]);
  if(user.rows.length>0 && user.rows[0].coins >= 5000){
    await pool.query('UPDATE users SET coins=coins-5000 WHERE telegram_id=$1',[telegram_id]);
    res.json({success:true, msg:`5000 Coins withdrawn to ${method}`});
  } else res.json({success:false, msg:'Not enough coins'});
});

// শর্তাবলী
app.get('/terms', (req,res)=>{
  res.sendFile(__dirname + '/public/terms.html');
});

app.listen(port, ()=>{
  console.log(`Server running at http://localhost:${port}`);
});
